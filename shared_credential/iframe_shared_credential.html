<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="initial-scale=1, maximum-scale=10, minimum-scale=1, width=device-width, minimal-ui">
<style>
  .failed {
    color : red;
    font-weight: 800;
  }

  .success, .failed {
    border: 1px solid #8b8b8b;
  }
</style>
<script>
  function $(id) {
    return document.querySelector(id);
  }

  function dumpObject(obj) {
    var result = '{';
    for (var i in obj) {
      if (typeof(obj[i]) == 'function') {
        continue;
      }

      if (Array.isArray(obj)) {
        result += i + ':['
        for (var item of obj) {
          result += dumpObject(item) + ',  ';
        }
        result += '], '
      }

      if (typeof(obj[i]) == 'object') {
        result += i + ':' + dumpObject(obj[i]) + ', ';
        continue;
      }

      result += i + ':' + obj[i] + ', ';
    }
    result += '}';
    return result;
  }
</script>
<script>
  var all_succcess = true;
  // test utils
  function success(op, result) {
    var msg = op + ', succeed' + (result ? (', ' + result) : '');
    console.log(msg);
    var div = document.createElement('DIV');
    div.classList.add('success');
    div.innerText = msg;
    $('#container').append(div);
  }

  function failed(op, reason) {
    all_succcess = false;
    var msg = op + ', failed' + (reason ? (', ' + reason) : '');
    console.log(msg);
    console.error(op);
    if (reason) {
      console.error(reason);
    }
    var div = document.createElement('DIV');
    div.classList.add('failed');
    div.innerText = msg;
    $('#container').append(div);
  }

  // view utils
  function clearContainer(container) {
    container.innerHTML = "";
  }
</script>
<script>
  function doTest() {
    console.log('------------test begin-------------');
    if (!navigator.sharedCredentials) {
      failed('isSupported', 'navigator.sharedCredentials is not Supported');
      return;
    }
    if (!SharedCredential) {
      failed('SharedCredential', 'SharedCredential is not Supported');
      return;
    }

    var cre = new SharedCredential({
      username: 'John',
      credentialType: 'password',
      content: new Uint8Array([0,1,2,3,4,5]).buffer,
      userAuth: false,
      displayName: "John's password",
      avatarUrl: 'xxxx.html',
      tag: 'John password',
      syncAble: false,
    });

    var checkIsSupported = function() {
      navigator.sharedCredentials.isSupported().then((supported)=>{
        failed('isSupported', 'isSupported: ' + supported);
        checks.shift().call();
      }).catch((e)=>{
        if (e.name == 'NotAllowedError') {
          success('isSupported', e);
        } else {
          failed('isSupported', e);
        }
        checks.shift().call();
      });
    }

    var checkSave = function() {
      navigator.sharedCredentials.save(cre).then(()=>{
        failed('save', 'save ok');
        checks.shift().call();
      }).catch((e)=>{
        if (e.name == 'NotAllowedError') {
          success('save', e);
        } else {
          failed('save', e);
        }
        checks.shift().call();
      });
    }

    var checkFind = function() {
      navigator.sharedCredentials.find([]).then((credentials)=>{
        failed('find', 'find ok');
        checks.shift().call();
      }).catch((e)=>{
        if (e.name == 'NotAllowedError') {
          success('find', e);
        } else {
          failed('find', e);
        }
        checks.shift().call();
      });
    }

    var checkDelete = function() {
      navigator.sharedCredentials.delete(cre).then((msg)=>{
        failed('delete', 'delete ok');
        checks.shift().call();
      }).catch((e)=>{
        if (e.name == 'NotAllowedError') {
          success('delete', e);
        } else {
          failed('delete', e);
        }
        checks.shift().call();
      });
    }

    var checkGetContent = function() {
      cre.getContent().then((content)=>{
        failed('getContent', 'content : ' + content);
        checks.shift().call();
      }).catch((e)=>{
        if (e.name == 'NotAllowedError') {
          success('getContent', e);
        } else {
          failed('getContent', e);
        }
        checks.shift().call();
      });
    }


    var checks = [];
    checks.push(checkIsSupported);
    checks.push(checkSave);
    checks.push(checkFind);
    checks.push(checkGetContent);
    checks.push(checkDelete);

    checks.push(()=>{
      if (all_succcess) {
        success('All test done');
      } else {
        failed('All test done');
      }
    });

    checks.shift().call();

  }

  function init() {
    setTimeout(doTest, 500);
  }
</script>
</head>
<body onload='init()'>
  <div id='container'></div>
</body>
</html>
